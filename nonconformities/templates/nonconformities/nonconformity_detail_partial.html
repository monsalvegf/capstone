<div class="detail-content">
    <!-- Mostrar la fecha de creación y la descripción -->
    <h3>No Conformidad {{ nonconformity.code }}</h3>
    <p><strong>Fecha de Creación:</strong> {{ nonconformity.creation_date|date:"d/m/Y" }}</p>
    <p><strong>Descripción:</strong> {{ nonconformity.description }}</p>
    <p><strong>Estado Actual:</strong> <span id="current-status">{{ nonconformity.status.description|default:"Sin estado" }}</span></p>
    {% if nonconformity.closure_date %}
        <p><strong>Fecha de Cierre:</strong> <span id="closure-date">{{ nonconformity.closure_date|date:"d/m/Y" }}</span></p>
    {% endif %}
    <p><strong>Severidad:</strong> {{ nonconformity.severity.name|default:"No especificada" }}</p>
    <p><strong>Área:</strong> {{ nonconformity.area.description|default:"No especificada" }}</p>
    <p><strong>Categoría:</strong> {{ nonconformity.category.description|default:"No especificada" }}</p>

    <!-- Controles de gestión -->
    <div class="nc-controls" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
        <h4>Gestión</h4>

        <!-- Botón Editar NC -->
        <div style="margin-bottom: 15px;">
            <a href="{% url 'nonconformities:update_nonconformity' nonconformity.pk %}" class="btn btn-secondary btn-sm">
                ✏️ Editar NC
            </a>
        </div>

        <!-- Cambiar estado -->
        <form method="post" action="{% url 'nonconformities:change_status' nonconformity.pk %}" id="change-status-form" style="margin-bottom: 10px;">
            {% csrf_token %}
            <label for="status-select"><strong>Cambiar Estado:</strong></label>
            <select name="status" id="status-select" style="padding: 5px; margin-right: 10px;">
                <option value="">-- Seleccione --</option>
                {% for status in statuses %}
                    <option value="{{ status.id }}" {% if nonconformity.status.id == status.id %}selected{% endif %}>
                        {{ status.description }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-sm">Actualizar Estado</button>
        </form>

        <!-- Botones de acción -->
        <div style="margin-top: 10px;">
            {% if not nonconformity.closure_date %}
                <a href="{% url 'nonconformities:close_nonconformity' nonconformity.pk %}" class="btn btn-danger btn-sm">
                    Cerrar NC
                </a>
            {% else %}
                <form method="post" action="{% url 'nonconformities:reopen_nonconformity' nonconformity.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('¿Está seguro de reabrir esta NC?');">
                        Reabrir NC
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <!-- Mostrar las líneas de acción -->
    <h4 style="margin-top: 30px;">Acciones Registradas:</h4>
    <ul id="actions-list" style="list-style: none; padding: 0;">
        {% if action_lines %}
            {% for line in action_lines %}
                <li style="margin-bottom: 15px; padding: 10px; background: #fafafa; border-left: 3px solid #4F81BD; border-radius: 3px;">
                    <p style="margin: 0 0 5px 0; font-size: 12px; color: #666;">
                        <strong>Fecha:</strong> {{ line.date|date:"d/m/Y H:i" }} |
                        <strong>Usuario:</strong> {{ line.user.username|default:"Sin asignar" }}
                    </p>
                    <p style="margin: 0;">{{ line.action_description }}</p>
                </li>
            {% endfor %}
        {% else %}
            <li id="no-actions-message" style="color: #999; font-style: italic;">
                No hay acciones registradas para esta no conformidad.
            </li>
        {% endif %}
    </ul>

    <!-- Formulario para agregar nueva acción -->
    <div class="add-action-form" style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px; border: 1px solid #ddd;">
        <h4 style="margin-top: 0;">Agregar Nueva Acción</h4>
        <form method="post" action="{% url 'nonconformities:add_action' nonconformity.pk %}" id="add-action-form">
            {% csrf_token %}
            <div class="form-group" style="margin-bottom: 10px;">
                <label for="action_description" style="display: block; margin-bottom: 5px; font-weight: bold;">
                    Descripción de la Acción:
                </label>
                <textarea
                    name="action_description"
                    id="action_description"
                    rows="3"
                    required
                    placeholder="Describa la acción realizada o planificada..."
                    style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; box-sizing: border-box;"
                ></textarea>
                <small style="display: block; color: #666; margin-top: 5px;">
                    Mínimo 5 caracteres
                </small>
            </div>
            <div id="form-errors" style="color: #dc3545; margin-bottom: 10px; display: none;"></div>
            <button type="submit" class="btn btn-primary btn-sm">
                Agregar Acción
            </button>
        </form>
    </div>
</div>

<script>
// Script para enviar el formulario vía AJAX y actualizar la lista sin recargar
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-action-form');
    const actionsList = document.getElementById('actions-list');
    const formErrors = document.getElementById('form-errors');
    const noActionsMessage = document.getElementById('no-actions-message');

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(form);
            const url = form.action;

            // Limpiar errores previos
            formErrors.style.display = 'none';
            formErrors.textContent = '';

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Crear nuevo elemento de acción
                    const newAction = document.createElement('li');
                    newAction.style.marginBottom = '15px';
                    newAction.style.padding = '10px';
                    newAction.style.background = '#fafafa';
                    newAction.style.borderLeft = '3px solid #4F81BD';
                    newAction.style.borderRadius = '3px';
                    newAction.innerHTML = `
                        <p style="margin: 0 0 5px 0; font-size: 12px; color: #666;">
                            <strong>Fecha:</strong> ${data.action.date} |
                            <strong>Usuario:</strong> ${data.action.user}
                        </p>
                        <p style="margin: 0;">${data.action.description}</p>
                    `;

                    // Eliminar mensaje "No hay acciones" si existe
                    if (noActionsMessage) {
                        noActionsMessage.remove();
                    }

                    // Agregar nueva acción al final de la lista
                    actionsList.appendChild(newAction);

                    // Limpiar el formulario
                    form.reset();

                    // Mostrar mensaje de éxito (opcional, ya que se ve visualmente)
                    // Podrías agregar una notificación temporal aquí
                    console.log(data.message);
                } else {
                    // Mostrar errores
                    formErrors.style.display = 'block';
                    formErrors.textContent = data.message || 'Error al agregar la acción.';
                    if (data.errors) {
                        formErrors.textContent += ' ' + JSON.stringify(data.errors);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                formErrors.style.display = 'block';
                formErrors.textContent = 'Error de conexión. Por favor, intente nuevamente.';
            });
        });
    }
});
</script>
